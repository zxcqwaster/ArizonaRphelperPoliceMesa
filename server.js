const fs = require('fs');
const path = require('path');
const readline = require('readline');
const express = require('express');
const OpenAI = require('openai');

const app = express();
const port = Number(process.env.PORT || 3000);
const configPath = path.join(__dirname, 'aipd.local.json');

function readStoredConfig() {
  try {
    if (!fs.existsSync(configPath)) {
      return {};
    }

    const raw = fs.readFileSync(configPath, 'utf8');
    const parsed = JSON.parse(raw);
    return typeof parsed === 'object' && parsed ? parsed : {};
  } catch (error) {
    console.warn('Failed to read aipd.local.json:', error.message);
    return {};
  }
}

function storeConfig(config) {
  fs.writeFileSync(configPath, JSON.stringify(config, null, 2), 'utf8');
}

function askHidden(question) {
  return new Promise((resolve) => {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    rl.question(question, (answer) => {
      rl.close();
      resolve(answer.trim());
    });
  });
}

async function resolveApiKey() {
  if (process.env.OPENAI_API_KEY) {
    return process.env.OPENAI_API_KEY.trim();
  }

  const stored = readStoredConfig();
  if (stored.openaiApiKey) {
    return String(stored.openaiApiKey).trim();
  }

  console.log('Первый запуск AIPD сервера: введите OPENAI API key.');
  const key = await askHidden('API key: ');

  if (!key) {
    return '';
  }

  storeConfig({ ...stored, openaiApiKey: key });
  console.log('Ключ сохранен в aipd.local.json (локально).');
  return key;
}

const SYSTEM_PROMPT = `Ты — ИИ-помощник сотрудника полиции Arizona RP Mesa.
Отвечай коротко, по делу, на русском языке.
Если вопрос связан с уставом/ЕФК — опирайся на предоставленную базу знаний.
Если данных недостаточно — прямо скажи, что нужен фрагмент правил/доказательства.
Не придумывай несуществующие статьи.
Всегда предлагай безопасный и законный с точки зрения сервера вариант действий.
По RP-вопросам давай практичные примеры отыгровок и поясняй формат команд.`;

const KNOWLEDGE_BASE = `
Полная база знаний Arizona RP Mesa (МЮ):

[Источник и приоритет]
- Ниже собран расширенный свод по уставу МЮ, стадиям силы, юрисдикциям, задержанию, обыскам, трафик-стопам, погоням, /z метке, гос.волне, тэн/ситуационным кодам и ЕФК.
- Если вопрос спорный/узкий — требуются доказательства (видео, /time, RP-отыгровки) и проверка актуальной форумной версии.
- Игнорируй мусорные строки/служебные вставки в тексте источника.

====================================================
ГЛАВА A. УСТАВ МЮ — БАЗА
====================================================
1) Общие правила:
- Устав обязателен для всех сотрудников МЮ.
- Неоднократные нарушения ведут к взысканиям вплоть до увольнения/ЧС.
- Незнание устава не освобождает от ответственности.

2) Базовые обязанности:
- Ловля преступников и опасных лиц.
- Соблюдение стадий применения силы.
- Обеспечение безопасности граждан.
- Исполнение приказов старших (кроме заведомо преступных).
- Знание и соблюдение ЕФК.
- Обязательное зачитывание Миранды задержанному.
- Корректная парковка служебного транспорта.

3) Основные запреты (ключевые):
- Злоупотребление полномочиями, взятки, связи с ОПГ, продажа служебного оружия.
- Выезд на вызов в одиночку (кроме регламентных исключений).
- Нахождение в ряде мест в рабочее время без причины (рынки/аукцион и т.п.).
- Нарушение строевой дисциплины, нецелевое использование рации/техники.
- Использование неслужебного ТС в форме (кроме оговоренных исключений).
- Служебная форма/ресурсы в личных целях.
- Неправомерные действия с розыском, штрафами, эвакуацией и ТСР-командами.
- Обыск/проверка без оснований, действия без RP-отыгровок.

4) Что разрешено:
- Доставка подозреваемых в департамент.
- Допрос/обыск при наличии основания по регламенту.
- Проверка документов при необходимости (посты, массовые места и др.).
- Применение огня при реальной угрозе жизни/здоровью.

5) График и прочее:
- ПД/ТСР: 10:00–21:00, обед 13:00–14:00.
- ФБР: 09:00–21:30, обед 13:00–14:00.
- Розыск обычно выдаётся по факту в пределах ~10 минут (кроме исключений: длительная погоня/CASE FILE/системное расследование).
- Для нарушителей в маске нужны отдельные условия доказывания личности.
- При ухудшении состояния задержанного — оказание первой помощи/доставка в медцентр.

====================================================
ГЛАВА B. СТАДИИ ПРИМЕНЕНИЯ СИЛЫ
====================================================
1. Присутствие сотрудника.
2. Устное предупреждение.
3. Физическая сила.
4. Спецсредства (тайзер/дубинка).
5. Оружие (при угрозе жизни сотруднику/гражданам).

====================================================
ГЛАВА C. ЮРИСДИКЦИИ
====================================================
- Нельзя пересекать чужую юрисдикцию без основания.
- Исключения: общая юрисдикция, ЧС, активная погоня, тренировки/спецоперации, иные веские причины.
- При пересечении — уведомление по рации департамента о причине.
- ФБР работает по всему штату.
- Мосты между городами имеют общую юрисдикцию.
- Вне рабочего дня у ПД/ШД общая юрисдикция 21:00–10:00.

====================================================
ГЛАВА D. ЗАДЕРЖАНИЕ, АРЕСТ, МИРАНДА
====================================================
Обязательный минимум при задержании:
1) Представиться и показать документы/жетон.
2) Назвать конкретную причину.
3) Зачитать Миранду.

Формулировка Миранды (смысл):
- Вы имеете право хранить молчание.
- Всё сказанное может быть использовано против вас в суде.
- Вам понятны ваши права?

Процесс (кратко):
- Дать законные требования об остановке (в т.ч. мегафон по ТС).
- Задержать/сковать, провести обыск по регламенту, изъять запрещённые предметы.
- Объявить розыск по релевантной статье.
- Доставить в департамент, оформить протокол, поместить по процедуре.

Важно при погоне по ТС:
- Перед стрельбой по колёсам — 3 предупреждения в мегафон с интервалом ~10 секунд.

====================================================
ГЛАВА E. ПРАВИЛА ОБЫСКА
====================================================
- Обыск без основания запрещён.
- Основания: задержание/арест/допрос, регламентные посты/проверки, отдельные спецрежимы.
- ФБР может проводить проверки в рамках полномочий.
- Нужны RP-отыгровки и фиксация обстоятельств на записи.

====================================================
ГЛАВА F. ПРАВИЛА РОЗЫСКА (/su)
====================================================
- Нужны доказательства (видео) и основания по статье.
- Нужны RP-отыгровки при выдаче.
- Нельзя выдавать розыск без причины, с неадекватной причиной, по просьбе третьих лиц вне регламента.
- Нельзя выдавать розыск сотрудникам МЮ/ТСР кроме оговорённых исключений.
- Для маски: как правило нельзя выдавать розыск, если личность не подтверждена (исключения по делу).
- Для новичков (до 10 лвл) есть ограничения по части нелегальных предметов.

====================================================
ГЛАВА G. ПОГОНЯ И TRAFFIC-STOP
====================================================
Погоня:
- Допустимы отступления от ПДД с минимальным ущербом.
- Можно повреждать ТС для остановки при соблюдении регламента.
- Запрещена стрельба по ТС в населённых пунктах (если не возникли отдельные законные основания).
- Запрещено использовать ESC-баг для преимущества.

Traffic-stop обычный:
- Корректная постановка крузера, контроль рук/двигателя, чёткие команды.
- Вежливое представление, причина остановки, проверка документов.
- Эскалация только при неподчинении/угрозе.

Traffic-stop повышенного риска:
- Командует один сотрудник.
- Подозреваемые выводятся по очереди.
- Патрули соблюдают безопасные дистанции и исключают перекрёстный огонь.

====================================================
ГЛАВА H. /z МЕТКА
====================================================
- Нельзя ставить метку без погони/задержания (кроме очевидного нарушения).
- Нельзя ставить на респавнах фракций, админ-мероприятиях, ряде ивентов/слётов.
- Нарушения могут вести к жёстким OOC санкциям.

====================================================
ГЛАВА I. ТЭН-КОДЫ И СИТУАЦИОННЫЕ КОДЫ (КЛЮЧЕВОЕ)
====================================================
Тэн-коды (часто используемые):
- 10-2: вышел в патруль.
- 10-3: радиомолчание.
- 10-4: принято.
- 10-13: запрашиваю напарника.
- 10-15: проводится арест.
- 10-18/10-36: требуется поддержка.
- 10-46: провожу обыск.
- 10-55: traffic-stop.
- 10-57 VICTOR: авто-погоня.
- 10-57 FOXTROT: пешая погоня.
- 10-66: stop повышенного риска.
- 10-99: ситуация урегулирована.
- 10-90: запрос на нарушение юрисдикции.

Ситуационные коды (база):
- CODE 2 / 2 HIGH / 3 — уровни приоритета реагирования.
- CODE 4 — помощь не требуется, ситуация завершена.
- CODE 5 — объединение/разъединение юнитов.
- CODE 6 (+ADAM/CHARLES/GEORGE/MARY) — следственные действия и профиль подкрепления.
- CODE 7 — убытие со службы/перерыв.
- CODE 10 — запрос диспетчера для проверки данных.
- CODE 30 (+ADAM/RINGER) — сигнализация на объекте.
- CODE 100 — блокирование путей отхода.

====================================================
ГЛАВА J. ОБЩЕНИЕ С ГРАЖДАНАМИ/ПОДОЗРЕВАЕМЫМИ/РУКОВОДСТВОМ
====================================================
- Обязательно представиться, назвать причину обращения, быть вежливым и тактичным.
- При требовании показать удостоверение (с исключениями по угрозе).
- С подозреваемым: кратко, чётко, без оскорблений и лишней агрессии.
- С руководством: строгая официальная форма, без перебиваний и нецензурной лексики.

====================================================
ГЛАВА K. ПАТРУЛИ, МАРКИРОВКИ, БЛОК-ПОСТЫ
====================================================
- Патруль по составу и форме — строго по регламенту.
- Ключевые маркировки: Mary, Lincoln, Adam, David, King, Air.
- Блок-пост и DUI-checkpoint — с правильной расстановкой объектов/докладов и процедурой проверок.

====================================================
ГЛАВА L. ЕФК (ЕДИНЫЙ ФЕДЕРАЛЬНЫЙ КОДЕКС) — ОПОРНЫЕ СТАТЬИ
====================================================
Примеры уголовных статей и уровней розыска:
- 1.1 Нападение на гражданского — 3 ур.
- 1.2 Нападение на сотрудника — 6 ур.
- 2.1 Вооруженное нападение — 6 ур.
- 3.1 Убийство — 6 ур.
- 4.1 Попытка угона — 2 ур.; 4.2 Угон — 4 ур.
- 5.1 Дача взятки — 3 ур.; 5.2 Получение взятки должностным — 5 ур. + орг. последствия.
- 6.1 Открытое ношение оружия — предупреждение/далее 3 ур.; 6.2 Без лицензии — 6 ур.; 6.4 Патроны — 3 ур. при отсутствии лицензии.
- 7.1/7.2 Заложники/похищение — 6 ур.
- 8.1 Неподчинение сотруднику при исполнении — 4 ур.
- 8.2 Неподчинение при ЧС/спецоперации — 6 ур.
- 8.3 Отказ оплатить штраф — 2 ур.
- 8.5 Попытка скрыться от задержания — 3 ур. (+ изъятие лицензии ТС при побеге на водительском месте).
- 9.1 Проникновение на охраняемую территорию — 3 ур.; 9.3 На военную базу — 6 ур.
- 10.1 Хранение наркотических — 3 ур.; 10.1.2 крупный размер 30+ — 5 ур.; 10.2/10.3 сбыт/употребление — 6 ур.
- 11.x Терроризм/содействие — обычно 6 ур.
- 12.1 Ложные показания — 3 ур.; 12.2 неадекватный вызов — 2 ур.
- 13.1 Хулиганство — 2 ур. + штраф.
- 14.1 Насилие/призывы к насилию на митинге — 6 ур.; 14.2 участие в несанкционированном митинге — 3 ур.
- 15.1 Соучастие — статья минус 1 звезда; 15.3 подстрекательство — 2 ур.
- 16.1 Вымогательство — 4 ур.; 16.2 должностным лицом — 6 ур. + орг. последствия.
- 17.1 Помеха сотруднику — 3 ур.
- 19.1 Кража частного имущества — 4 ур.; 19.2 гос. имущества — 6 ур.; 19.3 разбой с оружием — 6 ур.
- 20.1 Отказ предоставить документы — 2 ур.; 20.2 при ЧС/спецоперации — 6 ур.
- 21.1 Наезд на гражданского — 3 ур.; 21.2 на сотрудника — 6 ур.
- 22.1/22.2/22.3 Оскорбления/неадекват/провокации сотрудника при исполнении — 3 ур.
- 23.1 Сотрудничество гос.лиц с ОПГ — 6 ур.
- 24.1 Кража гос.имущества с военных/гос объектов — 6 ур.
- 25.1 Превышение должностных полномочий с корыстью — 6 ур.
- 26.x Экстремизм/вербовка/финансирование — 6 ур.
- 27.1 Угрозы гражданину — 3 ур.; 27.2 сотруднику — 4 ур.; 27.3 лидерам госорганизаций — 6 ур.
- 28.1/28.2 Нацизм/призывы — 4 ур.
- 42.1 Побег из-под ареста/стражи — 6 ур.

Примеры штрафных статей (денежные):
- 29.1 Вождение в опьянении — крупный штраф.
- 30.1 Телефон за рулем — штраф.
- 31.1 Встречная полоса — штраф.
- 32.x Рельсы/номера/шахта — штрафы по регламенту.
- 34.x Парковка/тротуар/обочина — штрафы.
- 35.x Затруднение движения — штрафы.
- 37.1 Переход в неположенном месте — штраф.
- 38.1 Использование городского ТС в личных целях — штраф.
- 40.x Фары — штрафы.
- 41.1 Браконьерство — штраф.

====================================================
ГЛАВА M. ДОКАЗАТЕЛЬСТВА И ОПРОВЕРЖЕНИЯ
====================================================
- Для спорных действий (/su, /ticket, /strafs, ТСР-действия и т.п.) хранятся видео-доказательства.
- На записи обязателен /time и читаемость.
- Записи хранятся минимум 5 суток.
- На запрос администрации/суда опровержение подаётся в установленный срок.

====================================================
ГЛАВА N. ROLE PLAY (RP): БАЗА И ЛОГИКА ОТЫГРОВОК
====================================================
- RP (Role Play) — отыгровка роли и характера своего персонажа, правдоподобные действия и речь в рамках игрового мира.
- Цель RP: проживать жизнь персонажа логично и последовательно, без нелогичных действий и перевода ситуации в свою пользу.

Команды RP (основа):
- /b — OOC-сообщение (вне RP-процесса, для уточнений).
- /me — действие/эмоция персонажа (обычно как действие от лица персонажа; на сервере используется как действие в прошедшем времени).
- /do — описание состояния мира/предметов/обстановки, а также уточняющие вопросы.
- /try — действие с вероятностным исходом (удачно/неудачно), только где действительно нужна вероятность.
- /todo — реплика + действие: текст*действие.

Оформление команд (важно):
- /me: маленькая буква, без точки в конце.
  Пример: /me почесал затылок
- /do: большая буква, в конце точка (или вопросительный знак, если это вопрос).
  Пример: /do Паспорт находится в кармане.
  Пример-вопрос: /do Водительское окно открыто?
- /try: оформляется по аналогии с /me (действие, без точки в конце).
- /todo: формат /todo Реплика*действие, действие лучше деепричастным оборотом.
  Пример: /todo Держите паспорт*передавая документ человеку напротив

РП-термины (часто используемые):
- DM — убийство без причины.
- DB — убийство машиной или из машины.
- SK — убийство при спавне.
- TK — убийство члена своей команды/организации.
- MG — метагейминг (смешение OOC и IC информации).
- PG — пауэргейминг (нереалистичное «геройство», игнор ограничений).
- RK — несколько значений в сообществе: return/revenge/repeat kill (учитывать контекст сервера).
- ZZ (Green Zone), BH (BunnyHop), GM (GodMode), SH (SpeedHack) — сопутствующие термины.

Ключевые принципы правильной RP-игры:
- Не отыгрывай за другого персонажа его реакцию, состояние, мысли, травмы и т.д.
- Для реакции другого персонажа используй вопрос через /do.
  Пример: /do Какова реакция Джонатана?
- Не переводи RP в свою сторону (не выдумывай удобные факторы/исходы в свою пользу).
- Не лги в /do о фактах, которые уже были отыграны в ситуации.
- Не используй /try для навязывания результата, влияющего на другого игрока (алкотестер, виновность в ДТП, состояние здоровья и т.п.).

Примеры корректного использования:
- /me правой рукой снял рацию с поясного держателя и поднес ее ко рту
- /do Брови Джонатана нахмурились.
- /do Переднее окно со стороны водителя открыто?
- /todo Привет!*помахав рукой

Примеры некорректного использования:
- /do Джонатан упал и потерял сознание. (если отыгрывается не самим Джонатаном)
- /try алкотестер показал, что водитель пьян (навязывание результата через /try)
- Неконкретные /do вида «/do Взгляд.» или «/do Передача.» без контекста.

Мифы, которые НЕ являются правилами сами по себе:
- Нельзя делать несколько /me подряд — миф (можно, если логично).
- Каждое /me обязательно завершать /do — миф.
- Нельзя указывать имена в отыгровке — миф (можно и часто полезно при нескольких участниках).

====================================================
ГЛАВА O. ОТВЕТЫ ИИ (ПОВЕДЕНИЕ)
====================================================
- Всегда отвечай кратко и по делу.
- Если вопрос про RP — давай готовые примеры в правильном формате команд (/me, /do, /try, /todo).
- Если есть риск нарушения регламента — предупреди и предложи безопасный легальный сценарий.
- Если не хватает данных (док-в, /time, контекста ЧС/юрисдикции/маски/RP-контекста) — прямо укажи, что нужно уточнить.
- Не придумывай статьи и наказания, которых нет в базе.
`;

async function start() {
  const apiKey = await resolveApiKey();
  if (!apiKey) {
    console.error('API ключ не задан. Укажите OPENAI_API_KEY или введите его на первом запуске.');
    process.exit(1);
  }

  const client = new OpenAI({ apiKey });

  app.use(express.json({ limit: '2mb' }));

  app.get('/health', (_, res) => {
    res.json({ ok: true });
  });

  app.post('/chat', async (req, res) => {
    try {
      const question = String(req.body?.question || '').trim();

      if (!question) {
        return res.status(400).json({ error: 'question is required' });
      }

      const response = await client.responses.create({
        model: process.env.OPENAI_MODEL || 'gpt-4-mini',
        input: [
          { role: 'system', content: SYSTEM_PROMPT },
          { role: 'system', content: KNOWLEDGE_BASE },
          { role: 'user', content: question }
        ],
        temperature: 0.2,
        max_output_tokens: 400
      });

      const answer = response.output_text?.trim() || 'Не удалось сформировать ответ.';
      return res.json({ answer });
    } catch (error) {
      console.error('Chat error:', error);
      return res.status(500).json({
        error: 'internal_error',
        details: error?.message || String(error)
      });
    }
  });

  app.listen(port, '0.0.0.0', () => {
    console.log(`AIPD server started on http://0.0.0.0:${port}`);
  });
}

start();
